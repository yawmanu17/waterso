<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WaterBill — Track Your Water & Sewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- removed html2canvas/jsPDF: printing will use browser Print (single-page report) -->
    <style>
      /* Sea-blue theme variables */
      :root{
        --sea-900: #003f5c;
        --sea-800: #01445a;
        --sea-700: #04607a;
        --sea-600: #0ea5b7;
        --sea-500: #06b6d4;
        --sea-300: #9feaf6;
        --sea-100: #e6fbfe;
        --muted: rgba(3,37,47,0.62);
      }

      /* Page background and base text */
      body {
        background: linear-gradient(180deg, var(--sea-50, #f6fdfe) 0%, #ffffff 60%);
        -webkit-font-smoothing:antialiased;
        color: var(--sea-900);
      }

      /* Responsive header/title and compact print button for mobile */
      .header-title{ display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: calc(100% - 110px); }
      #print-btn{ padding:6px 8px; font-size:12px; border-radius:6px; background:white; color:var(--sea-700); border:1px solid rgba(6,182,212,0.12); }
      @media (min-width:768px){
        #print-btn{ padding:8px 12px; font-size:14px; }
        .header-title{ max-width: none; }
      }

      /* Logo box uses sea gradient */
      .logo-box { background: linear-gradient(135deg, var(--sea-600), var(--sea-500)); }

      header h1 { color: var(--sea-900); }
      header p { color: var(--muted); }

      /* Cards and panels: subtle sea tint and better contrast */
      #app-root .bg-white { background: linear-gradient(180deg,#ffffff, var(--sea-100)); border: 1px solid rgba(6,182,212,0.06); }
      .rounded-xl { box-shadow: 0 6px 20px rgba(6,100,120,0.05); }
      .p-5 { color: var(--sea-900); }
      .card-title { color: var(--sea-700); font-weight:700; }

      /* Primary buttons adopt sea colors */
      .sea-primary, #calc-btn, #save-month, #print-btn { background: linear-gradient(135deg,var(--sea-700),var(--sea-600)); color: #fff !important; border-color: transparent !important; }
      #calc-btn:hover, #save-month:hover, #print-btn:hover { filter: brightness(1.05); }
      .no-print button { border: 1px solid rgba(6,182,212,0.12); }

      /* Improve table readability */
      table th { background: transparent; color: var(--sea-700); font-weight:700; }
      table td { color: rgba(2,32,45,0.95); }

      /* Tighter form labels and inputs for visibility */
      label.block { color: var(--sea-800); font-weight:600; }
      input, select { border-color: rgba(4,64,80,0.06); }

      footer { color: var(--muted); }

      /* Print: hide the app UI and show only the generated report (#print-report) */
      @media print {
        .no-print { display: none !important; }
        /* hide everything by default */
        body * { visibility: hidden !important; }
        /* show print-report container and its descendants */
        #print-report, #print-report * { visibility: visible !important; }
        /* position report at top-left for printing */
        #print-report { position: absolute; left: 0; top: 0; width: 100%; }
        /* ensure high contrast for printed report */
        #print-report { color: #04202b !important; background: #fff !important; }
        #print-report table th { color: #04202b !important; }
      }
    </style>
  </head>
  <body class="bg-gradient-to-b from-sky-50 via-white to-gray-50 text-gray-900 p-6">
    <div class="max-w-6xl mx-auto">
      <!-- hidden print container; populated by printReport() and displayed only during print -->
      <div id="print-report" style="display:none"></div>
      
      <!-- Authentication Modal -->
      <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
          <div class="text-center mb-6">
            <div class="w-16 h-16 logo-box text-white rounded-lg mx-auto mb-4 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2s5 5.5 5 9a5 5 0 11-10 0c0-3.5 5-9 5-9z"/></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900">OFORI-Water Bill</h2>
            <p class="text-gray-600">Access your water usage tracking</p>
          </div>

          <!-- Login Form -->
          <div id="login-form">
            <h3 class="text-xl font-semibold mb-4">Sign In</h3>
            <form id="login-form-element" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input id="login-email" type="email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your email">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input id="login-password" type="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your password">
              </div>
              <div id="login-error" class="text-red-600 text-sm" style="display:none"></div>
              <button type="submit" class="w-full sea-primary text-white py-3 px-4 rounded-lg font-medium hover:opacity-90 transition-opacity">
                Sign In
              </button>
            </form>
            <div class="mt-4 text-center">
              <p class="text-gray-600">Don't have an account? 
                <button id="show-signup" class="text-blue-600 hover:text-blue-800 font-medium">Sign up</button>
              </p>
            </div>
          </div>

          <!-- Signup Form -->
          <div id="signup-form" style="display:none">
            <h3 class="text-xl font-semibold mb-4">Create Account</h3>
            <form id="signup-form-element" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input id="signup-name" type="text" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your full name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input id="signup-email" type="email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your email">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input id="signup-password" type="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Create a password">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                <input id="signup-confirm-password" type="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Confirm your password">
              </div>
              <div id="signup-error" class="text-red-600 text-sm" style="display:none"></div>
              <button type="submit" class="w-full sea-primary text-white py-3 px-4 rounded-lg font-medium hover:opacity-90 transition-opacity">
                Create Account
              </button>
            </form>
            <div class="mt-4 text-center">
              <p class="text-gray-600">Already have an account? 
                <button id="show-login" class="text-blue-600 hover:text-blue-800 font-medium">Sign in</button>
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main App Content (hidden when not authenticated) -->
      <div id="main-app" style="display:none">
        <header class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 logo-box text-white rounded-lg flex items-center justify-center shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2s5 5.5 5 9a5 5 0 11-10 0c0-3.5 5-9 5-9z"/></svg>
            </div>
            <div>
              <h1 class="text-2xl font-bold header-title">OFORI-Water Bill</h1>
              <p class="text-sm text-gray-600">Water Monthly Usage & Yearly Analysis</p>
              <p class="text-sm font-semibold text-blue-700 mt-1">Welcome, <span id="user-name" class="font-bold text-blue-800">User</span>!</p>
              <!-- Name chosen: OFORI (from Solomon/Elizabeth/Andrew) -->
            </div>
          </div>

          <div class="flex items-center gap-2 no-print">
            <button id="logout-btn" class="px-3 py-2 text-sm text-gray-700 bg-gray-100 border rounded hover:bg-gray-200">Logout</button>
            <button id="print-btn" class="px-3 py-2 bg-white border rounded">Print / Save as PDF</button>
          </div>
        </header>

      <main class="grid grid-cols-1 md:grid-cols-3 gap-6" id="app-root">
        <section class="col-span-1 bg-white p-5 rounded-xl shadow-lg">
          <h2 class="font-semibold mb-4 text-lg">Customer & Meter</h2>
          <label class="block text-sm">Customer Address <span class="text-xs text-gray-400">(for reports)</span></label>
          <input id="cust-address" class="w-full p-2 border rounded mb-3" placeholder="123 Main St, City, State" />

          <label class="block text-sm">Meter Number</label>
          <input id="meter-number" class="w-full p-2 border rounded mb-3" placeholder="Meter #" />

          <h3 class="font-semibold mt-2 mb-2">Monthly Readings (CCF)</h3>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm">Last Read Date</label>
              <input id="last-read-date" type="date" class="w-full p-2 border rounded mb-2" />
            </div>
            <div>
              <label class="block text-sm">Current Read Date</label>
              <input id="current-read-date" type="date" class="w-full p-2 border rounded mb-2" />
            </div>
          </div>

          <label class="block text-sm">Last Read (CCF)</label>
          <input id="last-read" type="number" min="0" step="0.01" class="w-full p-2 border rounded mb-2" value="0" />

          <label class="block text-sm">Current Read (CCF)</label>
          <input id="current-read" type="number" min="0" step="0.01" class="w-full p-2 border rounded mb-2" value="0" />
          <div id="read-error" class="text-sm text-red-600 mt-1" style="display:none"></div>

          <div class="mt-3 text-sm space-y-2 bg-sky-50 p-3 rounded">
            <p class="text-gray-700"><strong>CCF Used:</strong> <span id="ccf-used" class="font-medium">0.00</span></p>
            <p class="text-gray-700"><strong>Gallons:</strong> <span id="gallons-used" class="font-medium">0</span></p>
          </div>

          <hr class="my-4" />

          <h3 class="font-semibold mb-2">Charges</h3>
          <label class="block text-sm">Water Base Service Charge</label>
          <input id="water-base" type="number" min="0" step="0.01" class="w-full p-2 border rounded mb-2" value="0.00" />

          <!-- Water charge mode below base charge -->
          <div class="mt-2 mb-2">
            <label class="block text-sm">Water Charge Mode</label>
            <div class="flex gap-4 items-center text-sm mt-1">
              <label class="inline-flex items-center"><input type="radio" name="water-charge-mode" id="water-mode-flat" value="flat" checked class="mr-2" />Charge by flat water rate per CCF</label>
              <label class="inline-flex items-center"><input type="radio" name="water-charge-mode" id="water-mode-tiered" value="tiered" class="mr-2" />Charge based on tiers</label>
            </div>
          </div>

          <!-- Water rate (shown for flat mode) -->
          <div id="water-rate-container" class="mb-2">
            <label class="block text-sm">Water Rate (per CCF)</label>
            <input id="water-rate" type="number" min="0" step="0.01" class="w-full p-2 border rounded" value="3.50" />
          </div>

          <!-- Tier inputs (shown for tiered mode) - dynamic add/remove -->
          <div id="tiers-container" class="hidden bg-white p-3 rounded border mb-2">
            <p class="text-xs text-gray-600 mb-2">Define cumulative tiers (usage billed across tiers). Enter the upper limit for each tier and its rate. Use Add Tier to insert more tiers.</p>
            <div id="tiers-list" class="space-y-2"></div>
            <div class="flex gap-2 mt-2">
              <button id="add-tier" type="button" class="px-3 py-1 bg-white border rounded text-sm">Add Tier</button>
              <button id="reset-tiers" type="button" class="px-3 py-1 bg-white border rounded text-sm">Reset Default 3</button>
            </div>

            <template id="tier-row-template">
              <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-3 text-sm text-gray-700">Tier <span class="tier-index">#</span></div>
                <div class="col-span-4">
                  <input type="number" class="tier-limit p-2 border rounded w-full" value="0" min="0" step="1" />
                </div>
                <div class="col-span-4">
                  <input type="number" class="tier-rate p-2 border rounded w-full" value="0.00" min="0" step="0.01" />
                </div>
                <div class="col-span-1 text-right">
                  <button type="button" class="remove-tier text-red-500">Remove</button>
                </div>
              </div>
            </template>
          </div>

          <!-- Utility tax percentage -->
          <label class="block text-sm">Utility Tax Rate (%)</label>
          <input id="utility-tax" type="number" min="0" step="0.01" class="w-full p-2 border rounded mb-2" value="0.00" />

          <hr class="my-4" />

          <h3 class="font-semibold mb-3 text-lg card-title">Sewer Services</h3>
          <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <label class="inline-flex items-center cursor-pointer">
              <input id="sewer-enabled" type="checkbox" class="w-4 h-4 mr-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" />
              <span class="text-base font-medium text-gray-800">Include sewer charges for this account</span>
            </label>
            <p class="text-sm text-gray-600 mt-2 ml-7">Check this box if your water bill includes sewer service charges</p>
          </div>

          <div id="sewer-fields" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200 mb-3">
            <h4 class="font-medium text-gray-800 mb-3">Sewer Service Charges</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700">Sewer Base Service Charge</label>
                <input id="sewer-base" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="0.00" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sewer Rate (per CCF)</label>
                <input id="sewer-rate" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="2.00" />
              </div>
            </div>
          </div>

          <!-- removed old tier checkbox area (moved above water rate) -->

          <label class="block text-sm">Billing Month</label>
          <input id="billing-month" type="month" class="w-full p-2 border rounded mb-3" />
          <div id="billing-month-error" class="text-sm text-red-600 mt-1" style="display:none"></div>

          <div class="flex gap-2">
            <button id="calc-btn" class="flex-1 bg-blue-600 text-white p-2 rounded">Calculate</button>
            <button id="save-month" class="flex-1 bg-green-600 text-white p-2 rounded">Save Month</button>
          </div>
        </section>

        <aside class="col-span-1 md:col-span-2 space-y-4">
          <div class="bg-white p-5 rounded-xl shadow-lg">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="font-semibold text-lg">Main Results</h3>
                <p class="text-sm text-gray-500">Summary for the selected billing period</p>
              </div>
              <div class="text-right text-xs text-gray-500">Unit: CCF / Gallons</div>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-4">
              <div class="p-3 bg-sky-50 rounded">
                <div class="text-xs text-gray-500">CCF Used</div>
                <div id="result-ccf" class="text-xl font-semibold">0.00</div>
              </div>
              <div class="p-3 bg-sky-50 rounded">
                <div class="text-xs text-gray-500">Gallons</div>
                <div id="result-gal" class="text-xl font-semibold">0</div>
              </div>
              <div class="p-3 bg-emerald-50 rounded">
                <div class="text-xs text-gray-500">Total $</div>
                <div id="result-total" class="text-xl font-semibold">$0.00</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-4">
              <div class="p-3 bg-white rounded border">
                <div class="text-xs text-gray-500">Water Charge</div>
                <div id="result-water" class="text-lg font-semibold">$0.00</div>
              </div>
              <div id="sewer-result-container" class="p-3 bg-blue-50 rounded border-2 border-blue-200">
                <div class="text-xs text-blue-600 font-medium">Sewer Charge</div>
                <div id="result-sewer" class="text-lg font-semibold text-blue-800">$0.00</div>
              </div>
            </div>
          </div>

          <div class="bg-white p-5 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold">Saved Months</h3>
                <p class="text-sm text-gray-500">Click Save to record the month.</p>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-500">Year</label>
                <select id="year-select" class="p-2 border rounded text-sm"></select>
              </div>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm border-collapse">
                <thead class="bg-gray-100"><tr>
                  <th class="p-2 text-left">Month</th>
                  <th class="p-2 text-right">CCF</th>
                  <th class="p-2 text-right">Gallons</th>
                  <th class="p-2 text-right">Total $</th>
                  <th class="p-2 text-center">Actions</th>
                </tr></thead>
                <tbody id="records-body"></tbody>
              </table>
            </div>

            <div class="mt-4">
              <canvas id="trend-chart" height="120"></canvas>
            </div>
          </div>

          <div class="bg-white p-5 rounded-xl shadow-lg">
            <h3 class="font-semibold">Yearly Summary & Comparison</h3>
            <p class="text-sm text-gray-500">Totals for selected year and comparison to previous year.</p>

            <div class="mt-3 grid grid-cols-2 gap-4">
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs text-gray-500">This year — Usage</div>
                <div id="year-usage" class="text-lg font-semibold">0 CCF</div>
                <div class="text-xs text-gray-500">Avg/month <span id="year-avg">0</span></div>
              </div>
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs text-gray-500">This year — Cost</div>
                <div id="year-cost" class="text-lg font-semibold">$0.00</div>
                <div class="text-xs text-gray-500">Change vs prev: <span id="year-change">—</span></div>
              </div>
            </div>
          </div>
        </aside>
      </main>
      <footer class="mt-6 text-xs text-gray-500 text-center">Built by Solomon Ofori Manu, All rights reserved</footer>
      </div>
      <!-- End Main App Content -->
    </div>

    <script>
      // Authentication System
      const AUTH_STORAGE_KEY = 'waterso_auth';
      const USERS_STORAGE_KEY = 'waterso_users';
      
      // Authentication state management
      class AuthManager {
        constructor() {
          this.currentUser = null;
          this.init();
        }

        init() {
          // Check if user is already logged in
          const authData = this.getAuthData();
          if (authData && authData.token && authData.userId) {
            const user = this.getUserById(authData.userId);
            if (user) {
              this.currentUser = user;
              this.showMainApp();
              return;
            }
          }
          this.showAuthModal();
        }

        getAuthData() {
          try {
            const data = localStorage.getItem(AUTH_STORAGE_KEY);
            return data ? JSON.parse(data) : null;
          } catch (e) {
            return null;
          }
        }

        setAuthData(userId, token) {
          try {
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ userId, token, timestamp: Date.now() }));
          } catch (e) {
            console.warn('Failed to save auth data');
          }
        }

        clearAuthData() {
          try {
            localStorage.removeItem(AUTH_STORAGE_KEY);
          } catch (e) {
            console.warn('Failed to clear auth data');
          }
        }

        getUsers() {
          try {
            const users = localStorage.getItem(USERS_STORAGE_KEY);
            return users ? JSON.parse(users) : [];
          } catch (e) {
            return [];
          }
        }

        saveUsers(users) {
          try {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
          } catch (e) {
            console.warn('Failed to save users');
          }
        }

        getUserById(userId) {
          const users = this.getUsers();
          return users.find(user => user.id === userId);
        }

        getUserByEmail(email) {
          const users = this.getUsers();
          return users.find(user => user.email.toLowerCase() === email.toLowerCase());
        }

        generateUserId() {
          return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        generateToken() {
          return 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 16);
        }

        register(name, email, password) {
          // Validate inputs
          if (!name || !email || !password) {
            throw new Error('All fields are required');
          }

          if (password.length < 6) {
            throw new Error('Password must be at least 6 characters long');
          }

          // Check if user already exists
          if (this.getUserByEmail(email)) {
            throw new Error('An account with this email already exists');
          }

          // Create new user
          const users = this.getUsers();
          const newUser = {
            id: this.generateUserId(),
            name: name.trim(),
            email: email.toLowerCase().trim(),
            password: password, // In a real app, this would be hashed
            createdAt: new Date().toISOString()
          };

          users.push(newUser);
          this.saveUsers(users);
          
          return newUser;
        }

        login(email, password) {
          const user = this.getUserByEmail(email);
          if (!user) {
            throw new Error('Invalid email or password');
          }

          if (user.password !== password) {
            throw new Error('Invalid email or password');
          }

          const token = this.generateToken();
          this.setAuthData(user.id, token);
          this.currentUser = user;
          
          return user;
        }

        logout() {
          this.currentUser = null;
          this.clearAuthData();
          this.showAuthModal();
        }

        showAuthModal() {
          document.getElementById('auth-modal').style.display = 'flex';
          document.getElementById('main-app').style.display = 'none';
        }

        showMainApp() {
          document.getElementById('auth-modal').style.display = 'none';
          document.getElementById('main-app').style.display = 'block';
          if (this.currentUser) {
            document.getElementById('user-name').textContent = this.currentUser.name;
          }
        }

        getCurrentUserId() {
          return this.currentUser ? this.currentUser.id : null;
        }
      }

      // Initialize auth manager
      const authManager = new AuthManager();

      // Original app constants and variables
      const STORAGE_KEY = 'waterso_state_v1';
      const LEGACY_KEY = 'watersom_state_v1';
      const $ = id => document.getElementById(id);
      const toMoney = v => '$' + Number(v || 0).toFixed(2);

      // elements
      const addressEl = $('cust-address');
      const meterEl = $('meter-number');
      const lastReadEl = $('last-read');
      const currentReadEl = $('current-read');
      const lastReadDateEl = $('last-read-date');
      const currentReadDateEl = $('current-read-date');
      const ccfUsedEl = $('ccf-used');
      const gallonsEl = $('gallons-used');
      const waterBaseEl = $('water-base');
      const waterRateEl = $('water-rate');
      const sewerEnabledEl = $('sewer-enabled');
      const sewerBaseEl = $('sewer-base');
      const sewerRateEl = $('sewer-rate');
      const sewerFields = $('sewer-fields');
      const billingMonthEl = $('billing-month');
      const calcBtn = $('calc-btn');
      const saveBtn = $('save-month');
  const tiersContainer = $('tiers-container');
  const waterModeFlat = $('water-mode-flat');
  const waterModeTiered = $('water-mode-tiered');
  const waterRateContainer = $('water-rate-container');
  const utilityTaxEl = $('utility-tax');
  const recordsBody = $('records-body');
  const printBtn = $('print-btn');

      const resultCcf = $('result-ccf');
      const resultGal = $('result-gal');
      const resultWater = $('result-water');
      const resultSewer = $('result-sewer');
      const resultTotal = $('result-total');

      const yearSelect = $('year-select');
      const yearUsageEl = $('year-usage');
      const yearAvgEl = $('year-avg');
      const yearCostEl = $('year-cost');
      const yearChangeEl = $('year-change');

      let trendChart = null;

      function migrateStorage(){ try{ const newVal = localStorage.getItem(STORAGE_KEY); const oldVal = localStorage.getItem(LEGACY_KEY); if(!newVal && oldVal) localStorage.setItem(STORAGE_KEY, oldVal); }catch(e){console.warn(e);} }
      
      function getUserStorageKey() {
        const userId = authManager.getCurrentUserId();
        return userId ? `${STORAGE_KEY}_${userId}` : STORAGE_KEY;
      }
      
      function loadState(){ 
        migrateStorage(); 
        try{ 
          const storageKey = getUserStorageKey();
          const raw = localStorage.getItem(storageKey); 
          return raw ? JSON.parse(raw) : { records: [] }; 
        }catch(e){ 
          return { records: [] }; 
        } 
      }
      
      function saveState(s){ 
        try{ 
          const storageKey = getUserStorageKey();
          localStorage.setItem(storageKey, JSON.stringify(s)); 
        }catch(e){ 
          console.warn(e); 
        } 
      }

      // helper: read tier rows from DOM into sorted array of {limit, rate}
      function readTiersFromDOM(){
        const list = [];
        const rows = document.querySelectorAll('#tiers-list > .tier-row');
        rows.forEach((r,idx)=>{
          const limitEl = r.querySelector('.tier-limit');
          const rateEl = r.querySelector('.tier-rate');
          const limit = Number(limitEl.value) || 0;
          const rate = Number(rateEl.value) || 0;
          list.push({ limit, rate });
        });
        // ensure sorted by limit ascending
        list.sort((a,b)=>a.limit - b.limit);
        return list;
      }

      function calcTieredCharge(ccf){
        // Flat mode: simple per-CCF rate
        if(waterModeFlat && waterModeFlat.checked) return ccf * (parseFloat(waterRateEl.value) || 0);

        // Tiered mode: compute across dynamic tiers
        const tiers = readTiersFromDOM();
        if(!tiers.length) return 0;
        let prev = 0, charge = 0;
        for(let i=0;i<tiers.length;i++){
          const upper = tiers[i].limit || 0;
          const rate = tiers[i].rate || 0;
          const tierUsage = Math.max(0, Math.min(ccf, upper) - prev);
          if(tierUsage > 0) charge += tierUsage * rate;
          prev = upper;
        }
        // if consumption beyond highest limit, charge at last tier's rate
        const lastRate = tiers[tiers.length-1].rate || 0;
        if(ccf > prev) charge += (ccf - prev) * lastRate;
        return charge;
      }

      // Validation helpers
      function showError(id, msg){ const el = document.getElementById(id); if(!el) return; if(msg){ el.style.display='block'; el.textContent = msg; } else { el.style.display='none'; el.textContent=''; } }

      function validateReads(){
        const last = parseFloat(lastReadEl.value) || 0;
        const curr = parseFloat(currentReadEl.value) || 0;
        if(curr < last){ showError('read-error','Current read must be equal or greater than Last read'); return false; }
        showError('read-error','');
        return true;
      }

      function validateBillingMonth(){
        const m = billingMonthEl.value || '';
        if(!m){ showError('billing-month-error','Please select a billing month'); return false; }
        showError('billing-month-error','');
        return true;
      }

      function validateTiers(){
        const tiers = readTiersFromDOM();
        if(!tiers.length) return true; // nothing to validate
        // ensure strictly increasing limits and non-negative rates
        for(let i=0;i<tiers.length;i++){
          const t = tiers[i];
          if(t.limit < 0) { alert('Tier limits must be non-negative'); return false; }
          if(t.rate < 0) { alert('Tier rates must be non-negative'); return false; }
          if(i>0 && tiers[i].limit <= tiers[i-1].limit){ alert('Tier limits must be increasing (each tier limit greater than previous)'); return false; }
        }
        return true;
      }

      function validateAll(){
        const ok1 = validateReads();
        const ok2 = validateBillingMonth();
        const ok3 = validateTiers();
        return ok1 && ok2 && ok3;
      }

      // returns array of { limit, rate, usage, cost, label }
      function computeTierBreakdown(ccf){
        const out = [];
        if(waterModeFlat && waterModeFlat.checked){
          const rate = parseFloat(waterRateEl.value) || 0;
          const cost = ccf * rate;
          out.push({ label:'Flat rate', limit: null, rate, usage: ccf, cost });
          return out;
        }
        const tiers = readTiersFromDOM();
        if(!tiers.length) return out;
        let prev = 0;
        for(let i=0;i<tiers.length;i++){
          const upper = Number(tiers[i].limit) || 0;
          const rate = Number(tiers[i].rate) || 0;
          const usage = Math.max(0, Math.min(ccf, upper) - prev);
          const cost = usage * rate;
          out.push({ label: `Tier ${i+1}`, limit: upper, rate, usage, cost });
          prev = upper;
        }
        // beyond last
        if(ccf > prev){ const lastRate = Number(tiers[tiers.length-1].rate) || 0; const usage = ccf - prev; out.push({ label: `Above ${prev}`, limit: null, rate: lastRate, usage, cost: usage * lastRate }); }
        return out;
      }

      function autoCalculateReads(){ const last = parseFloat(lastReadEl.value) || 0; const curr = parseFloat(currentReadEl.value) || 0; const ccf = Math.max(0, curr - last); const gallons = Math.round(ccf * 748); ccfUsedEl.textContent = ccf.toFixed(2) + ' CCF'; gallonsEl.textContent = gallons.toLocaleString() + ' gal'; resultCcf.textContent = ccf.toFixed(2); resultGal.textContent = gallons.toLocaleString(); return { ccf, gallons }; }

      function calculateCharges(){
        // basic validations before calculating (reads and tiers)
        if(!validateReads()) return { ccf:0, gallons:0, waterCharge:0, sewerCharge:0, taxAmount:0, total:0 };
        if(!validateTiers()) return { ccf:0, gallons:0, waterCharge:0, sewerCharge:0, taxAmount:0, total:0 };
        const { ccf, gallons } = autoCalculateReads();
  const breakdown = computeTierBreakdown(ccf);
  const waterChargeUsage = breakdown.reduce((s,b)=> s + (Number(b.cost)||0), 0);
  const waterBase = parseFloat(waterBaseEl.value) || 0;
  const waterChargeBeforeTax = waterBase + waterChargeUsage;
        let sewerChargeBeforeTax = 0;
        const sewerBase = parseFloat(sewerBaseEl?.value || 0) || 0;
        if(sewerEnabledEl.checked){ sewerChargeBeforeTax = sewerBase + (ccf * (parseFloat(sewerRateEl.value) || 0)); }

  // Utility tax applies only to water charges (not to sewer)
  const taxRate = (parseFloat(utilityTaxEl.value) || 0) / 100;
  const taxAmount = waterChargeBeforeTax * taxRate;
  const total = waterChargeBeforeTax + sewerChargeBeforeTax + taxAmount;

        resultWater.textContent = toMoney(waterChargeBeforeTax);
        resultSewer.textContent = toMoney(sewerChargeBeforeTax);
        // show tax and total
        const existingTax = document.getElementById('result-tax');
        if(!existingTax){
          const taxDiv = document.createElement('div');
          taxDiv.className = 'mt-2 text-sm text-gray-600';
          taxDiv.id = 'result-tax';
          taxDiv.innerHTML = `<div>Utility Tax: <strong>${toMoney(taxAmount)}</strong> (${(taxRate*100).toFixed(2)}%)</div>`;
          resultTotal.parentElement.appendChild(taxDiv);
        } else {
          existingTax.innerHTML = `<div>Utility Tax: <strong>${toMoney(taxAmount)}</strong> (${(taxRate*100).toFixed(2)}%)</div>`;
        }

        resultTotal.textContent = toMoney(total);
        resultCcf.textContent = ccf.toFixed(2);
        resultGal.textContent = gallons.toLocaleString();
        return { ccf, gallons, breakdown, waterCharge: waterChargeBeforeTax, sewerCharge: sewerChargeBeforeTax, taxAmount, total, waterBase, sewerBase, taxRate, mode: (waterModeTiered && waterModeTiered.checked) ? 'tiered' : 'flat' };
      }

  function renderRecords(){
    const state = loadState();
    const recs = (state.records||[]).slice().sort((a,b)=> (a.month||'').localeCompare(b.month||''));
    recordsBody.innerHTML='';
    recs.forEach((r,idx)=>{
      const tr = document.createElement('tr'); tr.className='border-b';
      const tiersMeta = r.tiers && r.tiers.length ? ` &middot; Tiers:${r.tiers.length}` : '';
      const meta = `<div class="text-xs text-gray-500">${r.mode || 'flat'} ${tiersMeta} ${r.taxAmount? '&middot; Tax:'+ (Number(r.taxAmount)||0).toFixed(2): ''}</div>`;
      tr.innerHTML = `<td class="p-2">${r.month}${meta}</td><td class="p-2 text-right">${Number(r.ccf).toFixed(2)}</td><td class="p-2 text-right">${Number(r.gallons).toLocaleString()}</td><td class="p-2 text-right">${toMoney(r.total)}</td><td class="p-2 text-center"><button data-idx="${idx}" class="delete-row text-red-500 text-sm">Delete</button> <button data-month="${r.month}" class="load-row text-blue-600 text-sm ml-2">Load</button></td>`;
      recordsBody.appendChild(tr);
    });

    // delete handlers
    Array.from(document.getElementsByClassName('delete-row')).forEach(btn=> btn.addEventListener('click', e=>{ const i = Number(e.target.dataset.idx); const s = loadState(); s.records.splice(i,1); saveState(s); renderRecords(); updateChart(); updateYearSelect(); }));

    // load handlers
    Array.from(document.getElementsByClassName('load-row')).forEach(btn=> btn.addEventListener('click', e=>{ const m = e.target.dataset.month; if(m) loadRecordByMonth(m); }));

    updateChart(); updateYearSelect();
  }

  // load a saved record into the form for editing (rebuilds tier rows)
  function loadRecordByMonth(month){
    const state = loadState();
    const rec = (state.records||[]).find(r=>r.month===month);
    if(!rec) return;
    billingMonthEl.value = rec.month || '';
    const last = (rec.lastRead != null) ? rec.lastRead : 0;
    lastReadEl.value = last;
    const curr = (rec.currentRead != null) ? rec.currentRead : (Number(rec.ccf || 0) + Number(last));
    currentReadEl.value = curr;
    lastReadDateEl.value = rec.lastReadDate || '';
    currentReadDateEl.value = rec.currentReadDate || '';
    addressEl.value = rec.address || state.address || '';
    meterEl.value = rec.meter || state.meter || '';
    waterBaseEl.value = (rec.waterBase != null) ? rec.waterBase : waterBaseEl.value;
    sewerBaseEl.value = (rec.sewerBase != null) ? rec.sewerBase : sewerBaseEl.value;
    waterRateEl.value = (rec.waterRate != null) ? rec.waterRate : waterRateEl.value;
    sewerRateEl.value = (rec.sewerRate != null) ? rec.sewerRate : sewerRateEl.value;
    utilityTaxEl.value = (rec.utilityTax != null) ? rec.utilityTax : (rec.taxRate != null ? (Number(rec.taxRate||0)*100).toFixed(2) : utilityTaxEl.value);
    // set sewer enabled
    const hasSewer = (rec.sewerBase && Number(rec.sewerBase)>0) || (rec.sewerRate && Number(rec.sewerRate)>0) || Boolean(rec.sewerCharge);
    sewerEnabledEl.checked = !!hasSewer;
    if(sewerEnabledEl.checked) sewerFields.classList.remove('hidden'); else sewerFields.classList.add('hidden');
    // rebuild tiers
    if(rec.mode === 'tiered'){
      if(waterModeTiered) waterModeTiered.checked = true;
      if(waterModeFlat) waterModeFlat.checked = false;
      tiersList.innerHTML = '';
      if(rec.tiers && rec.tiers.length){ rec.tiers.forEach(t=> tiersList.appendChild(createTierRow(t.limit, t.rate))); }
      else { resetDefaultTiers(); }
    } else {
      if(waterModeFlat) waterModeFlat.checked = true;
      if(waterModeTiered) waterModeTiered.checked = false;
      tiersList.innerHTML = '';
    }
    refreshTierLabels(); refreshTierVisibility(); calculateCharges(); updateChart();
  }

  function saveMonth(){ const m = billingMonthEl.value || new Date().toISOString().slice(0,7); const res = calculateCharges(); const state = loadState(); state.address = addressEl.value; state.meter = meterEl.value; state.records = state.records || []; const existing = state.records.find(r=>r.month===m);
    // capture current tiers
    const tiers = readTiersFromDOM();
    const rec = { month: m, year: m.slice(0,4), ccf: res.ccf, gallons: res.gallons, waterBase: res.waterBase || 0, waterRate: parseFloat(waterRateEl.value) || 0, tiers: tiers, sewerBase: res.sewerBase || 0, sewerRate: parseFloat(sewerRateEl.value) || 0, waterCharge: res.waterCharge, sewerCharge: res.sewerCharge, taxAmount: res.taxAmount || 0, taxRate: res.taxRate || 0, utilityTax: parseFloat(utilityTaxEl.value) || 0, mode: res.mode || 'flat', total: res.total, lastReadDate: lastReadDateEl.value || null, currentReadDate: currentReadDateEl.value || null };
    if(existing) Object.assign(existing, rec); else state.records.push(rec); saveState(state); renderRecords(); alert('Saved ' + m); }


      function getAvailableYears(){ const s = loadState(); const years = new Set(); (s.records||[]).forEach(r=>{ if(r.month && r.month.length>=4) years.add(r.month.slice(0,4)); }); return Array.from(years).sort(); }

      function updateYearSelect(){ const years = getAvailableYears(); yearSelect.innerHTML = ''; const allOpt = document.createElement('option'); allOpt.value='all'; allOpt.textContent='All'; yearSelect.appendChild(allOpt); years.forEach(y=>{ const o = document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o); }); yearSelect.value = years.includes(new Date().getFullYear().toString()) ? new Date().getFullYear().toString() : 'all'; updateYearSummary(); }

      function aggregateYear(year){ const s = loadState(); const recs = (s.records||[]).filter(r=> year==='all' ? true : (r.year===year)); const totalCcf = recs.reduce((a,b)=>a+Number(b.ccf||0),0); const totalCost = recs.reduce((a,b)=>a+Number(b.total||0),0); return { totalCcf, totalCost, months: recs.length, recs }; }

      function updateYearSummary(){ const year = yearSelect.value || 'all'; if(year==='all'){ yearUsageEl.textContent = '—'; yearCostEl.textContent = '—'; yearAvgEl.textContent = '—'; yearChangeEl.textContent = '—'; return; } const thisYear = aggregateYear(year); const prev = aggregateYear((Number(year)-1).toString()); yearUsageEl.textContent = `${thisYear.totalCcf.toFixed(2)} CCF`; yearAvgEl.textContent = thisYear.months ? (thisYear.totalCcf/thisYear.months).toFixed(2) : '0'; yearCostEl.textContent = toMoney(thisYear.totalCost); if(prev.months){ const pct = prev.totalCost ? ((thisYear.totalCost - prev.totalCost)/prev.totalCost)*100 : 100; yearChangeEl.textContent = `${pct>=0?'+':''}${pct.toFixed(1)}%`; } else yearChangeEl.textContent = '—'; updateChart(); }

      function updateChart(){
        const state = loadState();
        const selectedYear = (yearSelect && yearSelect.value) ? yearSelect.value : 'all';

        // If a specific year is selected, build Jan..Dec arrays (monthly KPI view)
        if(selectedYear && selectedYear !== 'all'){
          const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
          const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          const gallonsData = new Array(12).fill(0);
          const waterCostData = new Array(12).fill(0);
          const totalCostData = new Array(12).fill(0);
          const recs = (state.records||[]).filter(r=> r.month && r.month.slice(0,4) === selectedYear);
          recs.forEach(r=>{
            const m = r.month.slice(5,7);
            const idx = months.indexOf(m);
            if(idx>=0){ gallonsData[idx] += Number(r.gallons||0); totalCostData[idx] += Number(r.total||0); waterCostData[idx] += Number(r.waterCharge||0); }
          });

          const ctx = $('trend-chart').getContext('2d');
          if(trendChart){ try{ trendChart.destroy(); }catch(e){} }
          const cfg = {
            data: {
              labels,
              datasets: [
                { type: 'bar', label: 'Total $', data: totalCostData, backgroundColor: 'rgba(16,185,129,0.9)', yAxisID: 'y2' },
                { type: 'bar', label: 'Water $', data: waterCostData, backgroundColor: 'rgba(59,130,246,0.85)', yAxisID: 'y2' },
                { type: 'line', label: 'Gallons', data: gallonsData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.12)', yAxisID: 'y1', tension: 0.2, fill: false }
              ]
            },
            options: {
              responsive: true,
              interaction: { mode: 'index', intersect: false },
              stacked: false,
              scales: {
                y1: { type: 'linear', position: 'left', title: { display: true, text: 'Gallons' } },
                y2: { type: 'linear', position: 'right', title: { display: true, text: 'Dollars' }, grid: { drawOnChartArea: false } }
              },
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(ctx){ const v = ctx.raw; if(ctx.dataset.type === 'bar') return ctx.dataset.label + ': $' + Number(v).toFixed(2); return ctx.dataset.label + ': ' + Number(v).toLocaleString(); }
                  }
                }
              }
            }
          };
          trendChart = new Chart(ctx, cfg);
          return;
        }

        // default: show a timeline of saved records (month labels)
        let recs = (state.records||[]).slice().sort((a,b)=> (a.month||'').localeCompare(b.month||''));
        if(!recs.length){ const curMonth = billingMonthEl.value || new Date().toISOString().slice(0,7); const cur = calculateCharges(); recs = [{ month: curMonth, gallons: cur.gallons, total: cur.total }]; }
        const labels = recs.map(r=>r.month);
        const gallonsData = recs.map(r=>Number(r.gallons||0));
        const costData = recs.map(r=>Number(r.total||0));
        const ctx = $('trend-chart').getContext('2d');
        if(trendChart){ try{ trendChart.destroy(); }catch(e){} }

        const cfg = {
          data: {
            labels,
            datasets: [
              { type: 'bar', label: 'Total $', data: costData, backgroundColor: 'rgba(16,185,129,0.9)', yAxisID: 'y2' },
              { type: 'line', label: 'Gallons', data: gallonsData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.12)', yAxisID: 'y1', tension: 0.2, fill: false }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            scales: {
              y1: { type: 'linear', position: 'left', title: { display: true, text: 'Gallons' } },
              y2: { type: 'linear', position: 'right', title: { display: true, text: 'Dollars' }, grid: { drawOnChartArea: false } }
            },
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(ctx){ const v = ctx.raw; if(ctx.dataset.type === 'bar') return ctx.dataset.label + ': $' + Number(v).toFixed(2); return ctx.dataset.label + ': ' + Number(v).toLocaleString(); }
                }
              }
            }
          }
        };
        trendChart = new Chart(ctx, cfg);
      }


      // inline print report - populate hidden #print-report and call window.print()
      function printReport(){
        const calc = calculateCharges();
        const container = document.getElementById('print-report');
        if(!container) return window.print();
        const selMonth = billingMonthEl.value || new Date().toISOString().slice(0,7);
        // prefer selected year for yearly summary; fallback to record year or current year
        const selectedYear = (yearSelect && yearSelect.value && yearSelect.value !== 'all') ? yearSelect.value : new Date().getFullYear().toString();
        const thisYear = aggregateYear(selectedYear);
        const prevYear = aggregateYear((Number(selectedYear)-1).toString());
        const pctChange = (prevYear.totalCost && prevYear.totalCost>0) ? ((thisYear.totalCost - prevYear.totalCost)/prevYear.totalCost)*100 : null;

        // build HTML with structured tables and a numeric monthly summary (no page snapshot image)
        let monthTable = '';
        try{
          const s = loadState();
          const monthsLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          const monthsKeys = ['01','02','03','04','05','06','07','08','09','10','11','12'];
          const gallonsByMonth = new Array(12).fill(0);
          const totalByMonth = new Array(12).fill(0);
          const waterByMonth = new Array(12).fill(0);
          (s.records||[]).forEach(r=>{ if(r.month && r.month.slice(0,4)===selectedYear){ const m = r.month.slice(5,7); const idx = monthsKeys.indexOf(m); if(idx>=0){ gallonsByMonth[idx] += Number(r.gallons||0); totalByMonth[idx] += Number(r.total||0); waterByMonth[idx] += Number(r.waterCharge||0); } } });
          // build table rows only for months that have data or show full 12 rows (zeros allowed)
          monthTable = `<div style="margin-top:10px"><div style="font-size:12px;font-weight:600;margin-bottom:6px">Monthly Summary (${selectedYear})</div><table style="width:100%;border-collapse:collapse;font-size:12px"><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #eee">Gallons</th><th style="text-align:right;padding:6px;border-bottom:1px solid #eee">Water $</th><th style="text-align:right;padding:6px;border-bottom:1px solid #eee">Total $</th></tr>`;
          for(let i=0;i<12;i++){ monthTable += `<tr><td style="padding:6px;border-bottom:1px solid #f3f3f3">${monthsLabels[i]}</td><td style="padding:6px;border-bottom:1px solid #f3f3f3;text-align:right">${Number(gallonsByMonth[i]).toLocaleString()}</td><td style="padding:6px;border-bottom:1px solid #f3f3f3;text-align:right">${toMoney(waterByMonth[i])}</td><td style="padding:6px;border-bottom:1px solid #f3f3f3;text-align:right">${toMoney(totalByMonth[i])}</td></tr>`; }
          monthTable += '</table></div>';
        }catch(e){ monthTable = ''; }

  document.title = `OFORI-Water Bill_${selMonth}`;
        // build the report HTML in a variable. Do NOT inject into the page yet —
        // popup flow will use this string directly. Only use container when
        // falling back to inline printing.
        const reportHtml = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <h2 style="margin:0;font-size:18px">OFORI - Water Bill</h2>
              <div style="font-size:11px;color:#555">${addressEl.value||''}${meterEl.value? ' • Meter: '+meterEl.value:''}</div>
            </div>
            <div style="text-align:right;font-size:12px">${selMonth}</div>
          </div>
          <hr style="margin:8px 0">
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <div style="flex:1;min-width:280px">
              <h4 style="margin:0 0 8px 0">Inputs</h4>
              <table style="width:100%;font-size:13px;border-collapse:collapse">
                <tr><td style="padding:6px 8px;color:#333">Billing Month</td><td style="padding:6px 8px;text-align:right">${billingMonthEl.value || 'N/A'}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Last Read</td><td style="padding:6px 8px;text-align:right">${lastReadEl.value || 'N/A'} ${lastReadDateEl.value? '('+lastReadDateEl.value+')':''}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Current Read</td><td style="padding:6px 8px;text-align:right">${currentReadEl.value || 'N/A'} ${currentReadDateEl.value? '('+currentReadDateEl.value+')':''}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Water Base</td><td style="padding:6px 8px;text-align:right">${toMoney(waterBaseEl.value)}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Water Mode</td><td style="padding:6px 8px;text-align:right">${(waterModeTiered && waterModeTiered.checked)? 'Tiered' : 'Flat'}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Water Rate</td><td style="padding:6px 8px;text-align:right">${toMoney(waterRateEl.value)}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Utility Tax</td><td style="padding:6px 8px;text-align:right">${Number(utilityTaxEl.value || 0).toFixed(2)}%</td></tr>
              </table>
            </div>
            <div style="flex:1;min-width:260px">
              <h4 style="margin:0 0 8px 0">Results</h4>
              <table style="width:100%;font-size:13px;border-collapse:collapse">
                <tr><td style="padding:6px 8px;color:#333">CCF Used</td><td style="padding:6px 8px;text-align:right">${calc.ccf.toFixed(2)}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Gallons</td><td style="padding:6px 8px;text-align:right">${calc.gallons.toLocaleString()}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Water Charge</td><td style="padding:6px 8px;text-align:right">${toMoney(calc.waterCharge)}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Sewer Charge</td><td style="padding:6px 8px;text-align:right">${toMoney(calc.sewerCharge)}</td></tr>
                <tr><td style="padding:6px 8px;color:#333">Utility Tax (water only)</td><td style="padding:6px 8px;text-align:right">${toMoney(calc.taxAmount)}</td></tr>
                <tr><td style="padding:6px 8px;font-weight:700">Total</td><td style="padding:6px 8px;font-weight:700;text-align:right">${toMoney(calc.total)}</td></tr>
              </table>
            </div>
          </div>
          ${monthTable}
          <div style="margin-top:10px">
            <h4 style="margin:6px 0">Yearly Summary — ${selectedYear}</h4>
            <table style="width:100%;font-size:13px;border-collapse:collapse">
              <tr><td style="padding:6px 8px;color:#333">Total Usage (CCF)</td><td style="padding:6px 8px;text-align:right">${thisYear.totalCcf.toFixed(2)}</td></tr>
              <tr><td style="padding:6px 8px;color:#333">Months Recorded</td><td style="padding:6px 8px;text-align:right">${thisYear.months || 0}</td></tr>
              <tr><td style="padding:6px 8px;color:#333">Total Cost</td><td style="padding:6px 8px;text-align:right">${toMoney(thisYear.totalCost)}</td></tr>
              <tr><td style="padding:6px 8px;color:#333">Avg / month (CCF)</td><td style="padding:6px 8px;text-align:right">${thisYear.months? (thisYear.totalCcf/thisYear.months).toFixed(2) : '—'}</td></tr>
              <tr><td style="padding:6px 8px;color:#333">Change vs ${Number(selectedYear)-1}</td><td style="padding:6px 8px;text-align:right">${pctChange==null? '—' : ((pctChange>=0?'+':'')+pctChange.toFixed(1)+'%')}</td></tr>
            </table>
          </div>
            <div style="margin-top:12px;font-size:11px;color:#444;display:flex;justify-content:space-between;align-items:center">
            <div>Built by Solomon Ofori Manu, All rights reserved</div>
            <div style="font-size:11px;color:#666">OFORI</div>
          </div>
        `;
        // Try a popup print window first — more reliable on mobile browsers.
        try{
          // build a minimal printable HTML document
          const printStyles = `
            @page { size: A4; margin: 6mm; }
            body { font-family: Arial, Helvetica, sans-serif; color: #04202b; margin: 6mm; }
            h2{ margin:0 0 6px 0; }
            table{ width:100%; border-collapse: collapse; font-size: 11px; }
            table td, table th { padding:6px; border-bottom:1px solid #eee; }
            table th { text-align:left; color: #04202b; }
            @media print { img { max-width:100%; } }
          `;

          const printableHTML = `<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"/><title>${document.title}</title><style>${printStyles}</style></head><body>${reportHtml}<script>window.onload=function(){ setTimeout(function(){ try{ window.print(); }catch(e){} try{ window.close(); }catch(e){} },250); };<\/script></body></html>`;

          const popup = window.open('', '_blank');
          if(popup && popup.document){
            popup.document.open();
            popup.document.write(printableHTML);
            popup.document.close();
            // done — popup will call print and close itself
            return;
          }
        }catch(e){ /* fall through to inline print fallback */ }

        // fallback: use inline report with injected CSS and scale-to-fit (for desktop / blocked popups)
        let injectedStyle;
        try{
          const css = `
            @page { size: A4; margin: 6mm }
            @media print {
              html, body { height: 100%; }
              body * { visibility: hidden !important; }
              #print-report, #print-report * { visibility: visible !important; }
              #print-report { position: fixed !important; left: 6mm; top: 6mm; width: calc(210mm - 12mm) !important; box-sizing: border-box !important; }
              table { page-break-inside: avoid !important; }
              #print-report { font-size: 11px !important; line-height: 1.12 !important; }
              h2, h4 { margin: 0 0 6px 0 !important; }
            }
          `;
          injectedStyle = document.getElementById('ofori-print-style');
          if(!injectedStyle){ injectedStyle = document.createElement('style'); injectedStyle.id = 'ofori-print-style'; injectedStyle.type = 'text/css'; document.head.appendChild(injectedStyle); }
          injectedStyle.innerHTML = css;

          const pxPerMm = 96/25.4;
          const pageWidthMm = 210; const marginMm = 6;
          const availW = (pageWidthMm - marginMm*2) * pxPerMm;
          const availH = (297 - marginMm*2) * pxPerMm;
          // inject the report HTML into the hidden container for inline printing
          container.innerHTML = reportHtml;
          container.style.display = 'block';
          container.style.padding = '18px';
          container.style.fontFamily = 'Arial, Helvetica, sans-serif';
          container.style.color = '#111';
          container.style.width = (pageWidthMm - marginMm*2) + 'mm';
          container.style.boxSizing = 'border-box';
          container.style.fontSize = '11px';
          const contentW = Math.max(1, container.scrollWidth);
          const contentH = Math.max(1, container.scrollHeight);
          const scaleW = availW / contentW;
          const scaleH = availH / contentH;
          const scale = Math.min(1, scaleW, scaleH);
          container.style.transformOrigin = 'top left';
          container.style.transform = `scale(${scale})`;
        }catch(e){ /* ignore */ }

        setTimeout(()=>{
            try{ window.print(); }
          finally{
            try{ if(injectedStyle && injectedStyle.parentNode) injectedStyle.parentNode.removeChild(injectedStyle); }catch(e){}
            // cleanup the inline container (hide and remove content)
            try{ container.style.display='none'; container.style.transform=''; container.style.fontSize=''; container.style.width=''; container.innerHTML = ''; }catch(e){}
          }
        }, 400);
      }

      // events
  lastReadEl.addEventListener('input', autoCalculateReads);
  currentReadEl.addEventListener('input', autoCalculateReads);
  // show/hide tiers and water-rate based on selected mode
  function refreshTierVisibility(){
    if(waterModeTiered && waterModeTiered.checked){
      tiersContainer.classList.remove('hidden');
      if(waterRateContainer) waterRateContainer.classList.add('hidden');
      if(waterRateEl) waterRateEl.disabled = true;
  if(waterRateContainer) waterRateContainer.setAttribute('aria-hidden','true');
  if(tiersContainer) tiersContainer.setAttribute('aria-hidden','false');
    } else {
      tiersContainer.classList.add('hidden');
      if(waterRateContainer) waterRateContainer.classList.remove('hidden');
      if(waterRateEl) waterRateEl.disabled = false;
  if(waterRateContainer) waterRateContainer.setAttribute('aria-hidden','false');
  if(tiersContainer) tiersContainer.setAttribute('aria-hidden','true');
    }
    // update visible results immediately when mode changes
    try{ calculateCharges(); }catch(e){/* ignore during init */}
  }
  if(waterModeFlat) waterModeFlat.addEventListener('change', ()=> refreshTierVisibility());
  if(waterModeTiered) waterModeTiered.addEventListener('change', ()=> refreshTierVisibility());

  // dynamic tier management
  const tiersList = $('tiers-list');
  const addTierBtn = $('add-tier');
  const resetTiersBtn = $('reset-tiers');
  const tierTemplate = $('tier-row-template');

  function createTierRow(limit=0, rate=0){
    const tpl = tierTemplate.content.cloneNode(true);
    const wrapper = tpl.querySelector('div');
    wrapper.classList.add('tier-row');
    const limitEl = wrapper.querySelector('.tier-limit');
    const rateEl = wrapper.querySelector('.tier-rate');
    const idxEl = wrapper.querySelector('.tier-index');
    limitEl.value = limit;
    rateEl.value = rate;
    // remove button
    const removeBtn = wrapper.querySelector('.remove-tier');
    removeBtn.addEventListener('click', ()=>{ wrapper.remove(); refreshTierLabels(); calculateCharges(); updateChart(); });
    // recalc on input
    [limitEl, rateEl].forEach(el=> el.addEventListener('input', ()=>{ refreshTierLabels(); try{ calculateCharges(); }catch(e){} updateChart(); }));
    return wrapper;
  }

  function refreshTierLabels(){
    const rows = tiersList.querySelectorAll('.tier-row');
    rows.forEach((r,i)=>{ const idx = r.querySelector('.tier-index'); if(idx) idx.textContent = (i+1); });
  }

  function resetDefaultTiers(){
    tiersList.innerHTML = '';
    tiersList.appendChild(createTierRow(10,2.50));
    tiersList.appendChild(createTierRow(20,3.50));
    tiersList.appendChild(createTierRow(99999,5.00));
    refreshTierLabels();
  }

  addTierBtn.addEventListener('click', ()=>{ tiersList.appendChild(createTierRow(0,0.00)); refreshTierLabels(); calculateCharges(); updateChart(); });
  resetTiersBtn.addEventListener('click', ()=>{ resetDefaultTiers(); calculateCharges(); updateChart(); });

  // initialize tiers list with defaults if empty
  (function initTiers(){ if(tiersList){ if(!tiersList.children.length) resetDefaultTiers(); } })();

  // recalc when user edits rates or other charge inputs for immediate feedback
  [waterRateEl, utilityTaxEl, waterBaseEl, sewerBaseEl, sewerRateEl].forEach(el=>{
    if(!el) return;
    el.addEventListener('input', ()=> { try{ calculateCharges(); }catch(e){} updateChart(); });
  });
      sewerEnabledEl.addEventListener('change', ()=> { if(sewerEnabledEl.checked) sewerFields.classList.remove('hidden'); else sewerFields.classList.add('hidden'); });
  calcBtn.addEventListener('click', ()=> { calculateCharges(); updateChart(); });
  saveBtn.addEventListener('click', ()=>{ if(!validateAll()) return; saveMonth(); updateChart(); });
  printBtn.addEventListener('click', ()=> printReport());
      yearSelect.addEventListener('change', updateYearSummary);

      // Authentication event listeners
      function setupAuthEventListeners() {
        // Show/hide forms
        document.getElementById('show-signup').addEventListener('click', () => {
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('signup-form').style.display = 'block';
          clearAuthErrors();
        });

        document.getElementById('show-login').addEventListener('click', () => {
          document.getElementById('signup-form').style.display = 'none';
          document.getElementById('login-form').style.display = 'block';
          clearAuthErrors();
        });

        // Login form
        document.getElementById('login-form-element').addEventListener('submit', (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value.trim();
          const password = document.getElementById('login-password').value;
          
          try {
            authManager.login(email, password);
            authManager.showMainApp();
            clearAuthErrors();
            // Refresh data for new user
            renderRecords();
            updateYearSelect();
            autoCalculateReads();
          } catch (error) {
            showAuthError('login-error', error.message);
          }
        });

        // Signup form
        document.getElementById('signup-form-element').addEventListener('submit', (e) => {
          e.preventDefault();
          const name = document.getElementById('signup-name').value.trim();
          const email = document.getElementById('signup-email').value.trim();
          const password = document.getElementById('signup-password').value;
          const confirmPassword = document.getElementById('signup-confirm-password').value;
          
          try {
            if (password !== confirmPassword) {
              throw new Error('Passwords do not match');
            }
            
            authManager.register(name, email, password);
            authManager.login(email, password);
            authManager.showMainApp();
            clearAuthErrors();
            // Initialize data for new user
            renderRecords();
            updateYearSelect();
            autoCalculateReads();
          } catch (error) {
            showAuthError('signup-error', error.message);
          }
        });

        // Logout button
        document.getElementById('logout-btn').addEventListener('click', () => {
          if (confirm('Are you sure you want to logout?')) {
            authManager.logout();
          }
        });
      }

      function showAuthError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }

      function clearAuthErrors() {
        ['login-error', 'signup-error'].forEach(id => {
          const errorEl = document.getElementById(id);
          if (errorEl) {
            errorEl.textContent = '';
            errorEl.style.display = 'none';
          }
        });
      }

  (function init(){ 
    // Setup authentication first
    setupAuthEventListeners();
    
    // Only initialize app data if user is authenticated
    if (authManager.currentUser) {
      const state = loadState(); 
      if(state.address) addressEl.value = state.address; 
      if(state.meter) meterEl.value = state.meter; 
      renderRecords(); 
      updateYearSelect(); 
      autoCalculateReads(); 
      refreshTierVisibility();
    }
  })();
    </script>
  </body>
</html>
